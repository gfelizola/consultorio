<?xml version="1.0" encoding="utf-8"?>
<s:NavigatorContent xmlns:fx="http://ns.adobe.com/mxml/2009" 
					xmlns:s="library://ns.adobe.com/flex/spark" 
					xmlns:mx="library://ns.adobe.com/flex/mx" width="1004" height="500" creationComplete="init()">
	<fx:Script>
		<![CDATA[
			import app.controller.Navigation;
			import app.enums.EAreas;
			import app.model.AtividadeFisica;
			import app.model.Consulta;
			import app.model.DB;
			import app.model.Paciente;
			import app.util.General;
			
			import mx.containers.ViewStack;
			import mx.controls.Alert;
			import mx.events.CloseEvent;
			import mx.events.FlexEvent;
			import mx.formatters.DateFormatter;
			
			import nz.co.codec.flexorm.criteria.Criteria;
			import nz.co.codec.flexorm.criteria.Sort;
			
			private function init():void
			{
				var p:Paciente = General.pacienteAtual ;
				
				if( p == null )
				{
					Navigation.navega(EAreas.HOME);
					return ;
				}
				
				var idade:Number = ( new Date().fullYear ) - p.dataNascimento.fullYear ;
				txtIdade.text = idade + " ANOS" ;
				
				var perfil:String = "";
				
				txtSemanaGestacional.visible = false ;
				
				if( idade > 60 )
				{
					perfil = "IDOSO" ;
				}
				else if( idade < 20 )
				{
					perfil = "CRIANÇA" ;
				}
				else 
				{
					if( p.gestante )
					{
						perfil = "GESTANTE" ;
						if( p.dataUltimaMenstruacao ){
							txtSemanaGestacional.text = p.semanaGestacional + " SEMANA GESTACIONAL" ;
							txtSemanaGestacional.visible = true ;
						}
					}
					else
					{
						perfil = "ADULTO" ;
						if( p.nutriz ) perfil += " / NUTRIZ" ;
					}
				}
				
				txtPerfil.text = perfil ;
				
				var c:Criteria = DB.em.createCriteria(app.model.Consulta);
				c.addEqualsCondition("paciente_id", p.id );
				c.addSort("data_consulta", Sort.DESC );
				
				var consulta:app.model.Consulta = DB.em.fetchCriteriaFirstResult(c) as app.model.Consulta ;
				if( consulta )
				{
					var df:DateFormatter = new DateFormatter();
					df.formatString = "DD de MMMM de YYYY" ;
					txtUltimaConsulta.text = df.format( consulta.dataConsulta );
					
					txtUltimoIMC.text = consulta.antropometria.imc.toPrecision(2) ;
					
					var nivelAtividade:String = "" ;
					switch(consulta.atividadeFisica.nivel)
					{
						case AtividadeFisica.MUITO_ATIVO:
							nivelAtividade = "MUITO ATIVO" ;
							break;
						case AtividadeFisica.ATIVO:
							nivelAtividade = "ATIVO" ;
							break;
						case AtividadeFisica.POUCO_ATIVO:
							nivelAtividade = "POUCO ATIVO" ;
							break;
						case AtividadeFisica.SEDENTARIO:
							nivelAtividade = "SEDENTÁRIO" ;
							break;
					}
					
					txtAtividade.text = nivelAtividade ;
				}
				else
				{
					txtUltimaConsulta.text = "NENHUMA CONSULTA REALIZADA" ;
					txtUltimoIMC.text = "N/A" ;
					txtAtividade.text = "" ;
					
					Alert.noLabel = "Não" ;
					Alert.yesLabel = "Sim" ;
					
					Alert.show("Este paciente ainda não possui nenhuma consulta cadastrada.\nDeseja iniciar uma agora", "Confirma consulta", Alert.YES|Alert.NO, null, onAletaNovaConsulta);
				}
			}
			
			private function onAletaNovaConsulta(e:CloseEvent):void
			{
				if( e.detail == Alert.YES )
				{
					//TODO - MOVER PARA NOVA CONSULTA
					trace( "ir para nova consulta" );
					if( General.consultaAtual == null ) General.consultaAtual = new app.model.Consulta();
					ViewStack(this.parent).selectedIndex = 3 ;
				}
			}
			
		]]>
	</fx:Script>
	
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	
	<s:Rect x="10" y="10" width="205" height="480" radiusX="10" radiusY="10">
		<s:fill>
			<s:SolidColor color="#FAFDFE"></s:SolidColor>
		</s:fill>
	</s:Rect>
	
	<s:Rect x="225" y="10" width="769" height="480" radiusX="10" radiusY="10">
		<s:fill>
			<s:SolidColor color="#FAFDFE"></s:SolidColor>
		</s:fill>
	</s:Rect>
	<s:Label id="txtPerfil" x="20" y="20" width="185" height="30" color="#81BAEA" fontSize="20"
			 styleName="bold" text="ADULTO"/>
	
	<s:Label id="txtIdade" x="20" y="50" width="185" height="20" text="30 ANOS"/>
	<s:Label id="txtAtividade" x="20" y="70" width="185" height="20" text="SEDENTÁRIO"/>
	<s:Label id="txtSemanaGestacional" x="20" y="90" width="185" height="20" text="32 SEMANA GESTACIONAL"/>
	
	<s:Label x="20" y="200" width="185" height="30" color="#81BAEA" fontSize="20" styleName="bold" text="ÚLTIMA CONSULTA"/>
	<s:Label id="txtUltimaConsulta" x="20" y="230" width="185" height="60" text="30 ANOS"/>
	
	<s:Label x="20" y="350" width="185" height="30" color="#81BAEA" fontSize="20" styleName="bold" text="ÚLTIMO IMC"/>
	<s:Label id="txtUltimoIMC" x="20" y="380" width="185" height="20" text="18,5"/>
	
	<mx:HRule x="10" y="170" width="205" height="2" chromeColor="#E0EFFB"/>
	<mx:HRule x="10" y="330" width="205" height="2" chromeColor="#E0EFFB"/>
	
	<s:Label id="txtNomeGrafico" x="235" y="20" width="749" height="30" color="#81BAEA" fontSize="20"
			 styleName="bold" text="CURVA DE ATALAH"/>
	
	<s:Label id="txtDescricaoGrafico" x="235" y="50" width="749" height="49" text="FERRAMENTE DE AVALIAÇÃO DO ESTADO NUTRICIONAL DA GESTANTE" />
</s:NavigatorContent>
