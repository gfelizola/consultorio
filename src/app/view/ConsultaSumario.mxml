<?xml version="1.0" encoding="utf-8"?>
<s:NavigatorContent xmlns:fx="http://ns.adobe.com/mxml/2009" 
					xmlns:s="library://ns.adobe.com/flex/spark" 
					xmlns:mx="library://ns.adobe.com/flex/mx" width="1004" height="500" show="init()" creationComplete="init()">
	<fx:Script>
		<![CDATA[
			import app.controller.Navigation;
			import app.enums.EAreas;
			import app.model.AtividadeFisica;
			import app.model.Consulta;
			import app.model.DB;
			import app.model.Paciente;
			import app.util.General;
			import app.util.Helpers;
			import app.util.ImpressaoUtils;
			
			import mx.collections.ArrayCollection;
			import mx.containers.ViewStack;
			import mx.controls.Alert;
			import mx.events.CloseEvent;
			import mx.formatters.DateFormatter;
			
			import nz.co.codec.flexorm.criteria.Criteria;
			import nz.co.codec.flexorm.criteria.Sort;

			private var consultas:ArrayCollection;
			
			[Bindable]
			private var minIdade:Number;
			
			[Bindable]
			private var pesos:ArrayCollection;
			
			private function init():void
			{
				var p:Paciente = General.pacienteAtual ;
				
				if( p == null )
				{
					Navigation.navega(EAreas.HOME);
					return ;
				}
				
				if( p.dataNascimento ){
					var idade:Number = Helpers.idade(p.dataNascimento);
					txtIdade.text = idade + " ANOS" ;
				} else {
					txtIdade.visible = txtIdade.includeInLayout = false ;
				}
				
				var perfil:String = "";
				
				txtSemanaGestacional.visible = false ;
				
				if( idade > 60 )
				{
					perfil = "IDOSO" ;
					vsGraficos.selectedIndex = 3 ;
				}
				else if( idade < 20 )
				{
					perfil = "CRIANÇA" ;
					vsGraficos.selectedIndex = 1 ;
				}
				else 
				{
					if( p.gestante )
					{
						perfil = "GESTANTE" ;
						if( p.dataUltimaMenstruacao ){
							txtSemanaGestacional.text = p.semanaGestacional + "ª SEMANA GESTACIONAL" ;
							txtSemanaGestacional.visible = true ;
						} else {
							txtSemanaGestacional.visible = txtSemanaGestacional.includeInLayout = false ;
						}
						
						vsGraficos.selectedIndex = 2 ;
					}
					else
					{
						perfil = "ADULTO" ;
						if( p.nutriz ) perfil += " / NUTRIZ" ;
					}
				}
				
				txtPerfil.text = perfil ;
				
				var c:Criteria = DB.em.createCriteria(app.model.Consulta);
				c.addEqualsCondition("paciente", p.id );
				c.addSort("dataConsulta", Sort.DESC );
				
				consultas = DB.em.fetchCriteria(c);
				var consulta:app.model.Consulta = consultas.length > 0 ? consultas.getItemAt(0) as app.model.Consulta : null ;
				
				if( consulta )
				{
					var df:DateFormatter = new DateFormatter();
					df.formatString = "DD/MM/YYYY HH:NN" ;
					txtUltimaConsulta.text = df.format( consulta.dataConsulta );
					
					if( consulta.antropometria ){
						txtUltimoIMC.text = consulta.antropometria.imc.toFixed(2) ;
					} else {
						txtUltimoIMC.text = "N/A" ;
					}
					
					if( consulta.man ){
						resultadoMAN.text = consulta.man.estadoNutricionalGlobal.toString() ;
						ImpressaoUtils.criaMAN( consulta, containerMAN, false, 14 );
					}
					
					if( consulta.atividadeFisica )
					{
						var nivelAtividade:String = "" ;
						switch(consulta.atividadeFisica.nivel)
						{
							case AtividadeFisica.MUITO_ATIVO:
								nivelAtividade = "MUITO ATIVO" ;
								break;
							case AtividadeFisica.ATIVO:
								nivelAtividade = "ATIVO" ;
								break;
							case AtividadeFisica.POUCO_ATIVO:
								nivelAtividade = "POUCO ATIVO" ;
								break;
							case AtividadeFisica.SEDENTARIO:
								nivelAtividade = "SEDENTÁRIO" ;
								break;
						}
						
						txtAtividade.text = nivelAtividade ;
					} else {
						txtAtividade.visible = txtAtividade.includeInLayout = false ;
					}
				}
				else
				{
					txtUltimaConsulta.text = "NENHUMA CONSULTA REALIZADA" ;
					txtUltimoIMC.text = "N/A" ;
					txtAtividade.text = "" ;
					txtAtividade.visible = txtAtividade.includeInLayout = false ;
					
					Alert.noLabel = "Não" ;
					Alert.yesLabel = "Sim" ;
					
					Alert.show("Este paciente ainda não possui nenhuma consulta cadastrada.\nDeseja iniciar uma agora", "Confirma consulta", Alert.YES|Alert.NO, null, onAlertaNovaConsulta);
				}
				
				consultas.source.reverse();
				pesos = new ArrayCollection();
				
				minIdade = 0 ;
				var o:Object = {} ;
				
				for (var i:int = 0; i < consultas.length; i++) 
				{
					var cons:app.model.Consulta = consultas.getItemAt(i) as app.model.Consulta ;
					if( cons.antropometria ){
						
						o = {} ;
						if( cons.dataConsulta ) o.dataConsulta = General.getFormattedDate(cons.dataConsulta) ;
						if( cons.antropometria.peso ) o.peso = cons.antropometria.peso ;
						if( cons.antropometria.imc ) o.imc = cons.antropometria.imc ;
						if( cons.antropometria.estatura ) o.altura = cons.antropometria.estatura ;
						if( cons.semanaGestacional ) o.semana = cons.semanaGestacional ;
						if( cons.idadeNaConsulta() ) o.idade = cons.idadeNaConsulta() ;
						
						pesos.addItem(o);
						
						if( minIdade == 0 ) minIdade = cons.idadeNaConsulta() ;
					}
				}
				
				
				var atalah:ArrayCollection = new ArrayCollection();
				var tabelaAtalah:Array = [	
					[0  ,19.9  ,20.0  ,24.9  ,25.0  ,30.0  ,30.1  ],
					[1  ,19.9  ,20.0  ,24.9  ,25.0  ,30.0  ,30.1  ],
					[2  ,19.9  ,20.0  ,24.9  ,25.0  ,30.0  ,30.1  ],
					[3  ,19.9  ,20.0  ,24.9  ,25.0  ,30.0  ,30.1  ],
					[4  ,19.9  ,20.0  ,24.9  ,25.0  ,30.0  ,30.1  ],
					[5  ,19.9  ,20.0  ,24.9  ,25.0  ,30.0  ,30.1  ],
					[6  ,19.9  ,20.0  ,24.9  ,25.0  ,30.0  ,30.1  ],
					[7  ,19.9  ,20.0  ,24.9  ,25.0  ,30.0  ,30.1  ],
					[8  ,19.9  ,20.0  ,24.9  ,25.0  ,30.0  ,30.1  ],
					[9  ,19.9  ,20.0  ,24.9  ,25.0  ,30.0  ,30.1  ],
					[10 ,20.2  ,20.3  ,25.2  ,25.3  ,30.2  ,30.3  ],
					[11 ,20.3  ,20.4  ,25.3  ,25.4  ,30.3  ,30.4  ],
					[12 ,20.4  ,20.5  ,25.4  ,25.5  ,30.3  ,30.4  ],
					[13 ,20.6  ,20.7  ,25.6  ,25.7  ,30.4  ,30.5  ],
					[14 ,20.7  ,20.8  ,25.7  ,25.8  ,30.5  ,30.6  ],
					[15 ,20.8  ,20.9  ,25.8  ,25.9  ,30.6  ,30.7  ],
					[16 ,21.0  ,21.1  ,25.9  ,26.0  ,30.7  ,30.8  ],
					[17 ,21.1  ,21.2  ,26.0  ,26.1  ,30.8  ,30.9  ],
					[18 ,21.2  ,21.3  ,26.1  ,26.2  ,30.9  ,31.0  ],
					[19 ,21.4  ,21.5  ,26.2  ,26.3  ,30.9  ,31.0  ],
					[20 ,21.5  ,21.6  ,26.3  ,26.4  ,31.0  ,31.1  ],
					[21 ,21.7  ,21.8  ,26.4  ,26.5  ,31.1  ,31.2  ],
					[22 ,21.8  ,21.9  ,26.6  ,26.7  ,31.2  ,31.3  ],
					[23 ,22.0  ,22.1  ,26.8  ,26.9  ,31.3  ,31.4  ],
					[24 ,22.2  ,22.3  ,26.9  ,27.0  ,31.5  ,31.6  ],
					[25 ,22.4  ,22.6  ,27.0  ,27.1  ,31.6  ,31.7  ],
					[26 ,22.6  ,22.7  ,27.2  ,27.3  ,31.7  ,31.8  ],
					[27 ,22.7  ,22.8  ,27.3  ,27.4  ,31.8  ,31.9  ],
					[28 ,22.9  ,23.0  ,27.5  ,27.6  ,31.9  ,32.0  ],
					[29 ,23.1  ,23.2  ,27.6  ,27.7  ,32.0  ,32.1  ],
					[31 ,23.4  ,23.5  ,27.9  ,28.0  ,32.2  ,32.3  ],
					[32 ,23.6  ,23.7  ,28.0  ,28.1  ,32.3  ,32.4  ],
					[33 ,23.8  ,23.9  ,28.1  ,28.2  ,32.4  ,32.5  ],
					[34 ,23.9  ,24.0  ,28.3  ,28.4  ,32.5  ,32.6  ],
					[35 ,24.1  ,24.2  ,28.4  ,28.5  ,32.6  ,32.7  ],
					[36 ,24.2  ,24.3  ,28.5  ,28.6  ,32.7  ,32.8  ],
					[37 ,24.4  ,24.5  ,28.7  ,28.8  ,32.8  ,32.9  ],
					[38 ,24.5  ,24.6  ,28.8  ,28.9  ,32.9  ,33.0  ],
					[39 ,24.7  ,24.8  ,28.9  ,29.0  ,33.0  ,33.1  ],
					[40 ,24.9  ,25.0  ,29.1  ,29.2  ,33.1  ,33.2  ],
					[41 ,25.0  ,25.1  ,29.2  ,29.3  ,33.2  ,33.3  ],
					[42 ,25.0  ,25.1  ,29.2  ,29.3  ,33.2  ,33.3  ]
				];
				
				for (var j:int = 0; j < tabelaAtalah.length; j++) 
				{
					o = {};
					o.semana = tabelaAtalah[j][0];
					o.baixo = tabelaAtalah[j][1];
					o.ideal = tabelaAtalah[j][3];
					o.sobre = tabelaAtalah[j][5];
					o.imc = 0 ;
					
					for (i = 0; i < consultas.length; i++) 
					{
						var cons:app.model.Consulta = consultas.getItemAt(i) as app.model.Consulta ;
						if( cons.semanaGestacional ){
							if( cons.semanaGestacional == o.semana ) o.imc = Number( cons.antropometria.imc.toFixed(2) ) ;
						}
					}

					atalah.addItem(o);
				}
				
				curvaDeAtalah.dataProvider = atalah ;
			}
			
			private function onAlertaNovaConsulta(e:CloseEvent):void
			{
				if( e.detail == Alert.YES )
				{
					if( General.consultaAtual == null ) General.consultaAtual = new app.model.Consulta();
					ViewStack(this.parent).selectedIndex = 3 ;
				}
			}
		]]>
	</fx:Script>
	
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	
	<s:Rect x="10" y="10" width="205" height="480" radiusX="10" radiusY="10">
		<s:fill>
			<s:SolidColor color="#FAFDFE"></s:SolidColor>
		</s:fill>
	</s:Rect>
	
	<s:Rect x="225" y="10" width="769" height="480" radiusX="10" radiusY="10">
		<s:fill>
			<s:SolidColor color="#FAFDFE"></s:SolidColor>
		</s:fill>
	</s:Rect>
	
	
	<s:VGroup gap="6" x="20" y="20">
		<s:Label id="txtPerfil" x="20" width="185" height="30" color="#81BAEA" fontSize="20"
				 styleName="bold" text="ADULTO"/>
		
		<s:Label id="txtIdade" x="20" width="185" height="20" text="30 ANOS"/>
		<s:Label id="txtAtividade" x="20" width="185" height="20" text="SEDENTÁRIO"/>
		<s:Label id="txtSemanaGestacional" x="20" width="185" height="20" text="32 SEMANA GESTACIONAL"/>
	</s:VGroup>
	
	<s:Label x="20" y="200" width="185" height="30" color="#81BAEA" fontSize="20" styleName="bold" text="ÚLTIMA CONSULTA"/>
	<s:Label id="txtUltimaConsulta" x="20" y="230" width="185" height="60" text="30 ANOS"/>
	
	<s:Label x="20" y="350" width="185" height="30" color="#81BAEA" fontSize="20" styleName="bold" text="ÚLTIMO IMC"/>
	<s:Label id="txtUltimoIMC" x="20" y="380" width="185" height="20" text="18,5"/>
	
	<mx:HRule x="10" y="170" width="205" height="2" chromeColor="#E0EFFB"/>
	<mx:HRule x="10" y="330" width="205" height="2" chromeColor="#E0EFFB"/>
	
	<mx:ViewStack id="vsGraficos" x="235" y="22" width="750" height="460">
		<s:NavigatorContent width="100%" height="100%" label="Peso">
			<s:VGroup gap="5">
				
				<s:Label width="500" color="#81BAEA" fontSize="20" styleName="bold" text="GRÁFICO DE VARIAÇÃO DE PESO"/>
				<s:Label width="500" text="Evolução do peso corporal ao longo do acompanhamento nutricional." />
				
				<mx:LineChart id="curvaDePeso" dataProvider="{pesos}" width="720" height="390" showDataTips="true" seriesFilters="{[]}">
					<mx:horizontalAxis>
						<mx:CategoryAxis categoryField="dataConsulta" title="Data da consulta" />
					</mx:horizontalAxis>
					<mx:verticalAxis>
						<mx:LinearAxis title="Peso" />
					</mx:verticalAxis>
					
					<mx:series>
						<mx:LineSeries displayName="Peso" form="curve" yField="peso">
							<mx:lineStroke>
								<mx:SolidColorStroke color="#81BAEA" weight="7" />
							</mx:lineStroke>
							<mx:itemRenderer>
								<fx:Component>
									<mx:CrossItemRenderer />
								</fx:Component>
							</mx:itemRenderer>
						</mx:LineSeries>
					</mx:series>
					
				</mx:LineChart>
			</s:VGroup>
		</s:NavigatorContent>
		<s:NavigatorContent width="100%" height="100%" label="Peso">
			<s:VGroup gap="5">
				<s:Label width="500" color="#81BAEA" fontSize="20" styleName="bold" text="CURVA DE CRESCIMENTO"/>
				<s:Label width="500" text="As novas curvas de acompanhamento estabelecem, internacionalmente, um padrão para avaliar o crescimento e estado nutricional de crianças e adolescentes. São preconizadas pela Organização Mundial da Saúde e Ministério da Saúde." />
				
				<mx:LineChart id="curvaDeCrescimento" dataProvider="{pesos}" width="720" height="390" showDataTips="true" seriesFilters="{[]}">
					<mx:horizontalAxis>
						<mx:LinearAxis title="IDADE (meses)" minimum="{minIdade}" />
					</mx:horizontalAxis>
					<mx:verticalAxis>
						<mx:LinearAxis title="PESO (kg)" />
					</mx:verticalAxis>
					
					<mx:series>
						<mx:LineSeries displayName="Peso" form="curve" yField="peso" xField="idade">
							<mx:lineStroke>
								<mx:SolidColorStroke color="#81BAEA" weight="7" />
							</mx:lineStroke>
							<mx:itemRenderer>
								<fx:Component>
									<mx:CrossItemRenderer />
								</fx:Component>
							</mx:itemRenderer>
						</mx:LineSeries>
					</mx:series>
					
				</mx:LineChart>
			</s:VGroup>
		</s:NavigatorContent>
		<s:NavigatorContent width="100%" height="100%" label="Atalah">
			<s:VGroup gap="5">
				<s:Label width="720" color="#81BAEA" fontSize="20" styleName="bold" text="CURVA DE ATALAH"/>
				<s:Label width="720" text="Trata-se da ferramenta preconizada pela Organização Mundial da Saúde e Ministério da Saúde para avaliar a evolução do Índice de Massa Corporal (IMC) segundo a semana gestacional." />
				
				<mx:AreaChart id="curvaDeAtalah" width="600" height="350" showDataTips="true">
					<mx:horizontalAxis>
						<mx:CategoryAxis categoryField="semana" displayName="SEMANAS DE GESTAÇÃO" />
					</mx:horizontalAxis>
					<mx:verticalAxis>
						<mx:LinearAxis title="IMC" minimum="15" maximum="40" />
					</mx:verticalAxis>
					<mx:series>
						<mx:AreaSeries yField="baixo" displayName="Baixo Peso">
							<mx:areaFill>
								<s:SolidColor color="0xCCCCCC" alpha="0.5" />
							</mx:areaFill>
						</mx:AreaSeries>
						<mx:AreaSeries yField="ideal" displayName="Peso Adequado">
							<mx:areaFill>
								<s:SolidColor color="0xDDDDDD" alpha="0.5"  />
							</mx:areaFill>
						</mx:AreaSeries>
						<mx:AreaSeries yField="sobre" displayName="Sobrepeso">
							<mx:areaFill>
								<s:SolidColor color="0xEEEEEE" alpha="0.5" />
							</mx:areaFill>
						</mx:AreaSeries>
						<mx:AreaSeries yField="imc" displayName="IMC">
							<mx:areaStroke>
								<mx:SolidColorStroke color="0X81BAEA" weight="7" />
							</mx:areaStroke>
							<mx:areaFill>
								<s:SolidColor color="0xFFFFFF" alpha="0" />
							</mx:areaFill>
						</mx:AreaSeries>
					</mx:series>
				</mx:AreaChart>
				<mx:Legend dataProvider="{curvaDeAtalah}" direction="horizontal" />
			</s:VGroup>
		</s:NavigatorContent>
		<s:NavigatorContent width="100%" height="100%" label="MAN">
			<s:VGroup gap="20" width="100%">
				<s:Label width="100%" color="#81BAEA" fontSize="20" styleName="bold" text="RESULTADO DA MINI AVALIAÇÃO NUTRICIONAL"/>
				
				<s:VGroup gap="5" id="containerMAN" width="100%"></s:VGroup>
				
				<s:Label id="resultadoMAN" color="#81BAEA" fontSize="40" styleName="bold" text="" />
			</s:VGroup>
		</s:NavigatorContent>
	</mx:ViewStack>
</s:NavigatorContent>
